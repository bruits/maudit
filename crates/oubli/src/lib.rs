use archetypes::blog::BlogEntryContent;
use maudit::{
    content::{glob_markdown, ContentSource, ContentSources},
    coronate,
    page::FullPage,
};

pub use maudit::{content_sources, routes, BuildOptions, BuildOutput};

mod archetypes;

// Expose the layout module.
pub mod layouts {
    mod layout;
    pub use layout::layout;
}

/// Oubli provides Archetypes to help you quickly scaffold common types of content, like blogs or documentation.
#[derive(Debug, Clone)]
pub enum Archetype {
    /// Represents a markdown blog archetype.
    Blog,
    /// Represents a markdown documentation archetype.
    MarkdownDoc,
}

/// ðŸª¶ Oubli entrypoint. Starts the build process and generates the output files.
///
/// This function wraps Maudit's [`coronate`](maudit::coronate) function and adds an `archetypes` argument.
/// The user can specify one or more archetypes with their corresponding glob pattern. The routes and content
/// sources generated by these archetypes are merged with the routes and content sources provided directly.
///
/// ## Example
/// ```rust
/// use oubli::{Archetype, build_archetype, content_sources, forget, routes, BuildOptions, BuildOutput};
///
/// fn main() -> Result<BuildOutput, Box<dyn std::error::Error>> {
///   // Define archetypes and their glob patterns
///   let archetypes = &[
///     ("news", Archetype::Blog, "content/blog/**/*.md"),
///     ("docs", Archetype::MarkdownDoc, "content/docs/**/*.md"),
///     ("reference"), Archetype::OpenAPI, "content/reference/**/*.yaml"),
///   ];
///   forget(
///     archetypes,
///     routes![],
///     content_sources![],
///     BuildOptions::default(),
///   )
/// }
/// ```
pub fn forget(
    archetypes: &[(&str, Archetype, &str)],
    routes: &[&dyn FullPage],
    mut content_sources: ContentSources,
    options: BuildOptions,
) -> Result<BuildOutput, Box<dyn std::error::Error>> {
    // Start with user-custom routes.
    let mut combined_routes: Vec<&dyn FullPage> = routes.to_vec();

    // Process each archetype by generating its routes and content sources,
    // then combine them with the user-custom ones.
    for (name, arch, glob) in archetypes {
        match arch {
            Archetype::Blog => {
                let content_source = ContentSource::new(
                    *name,
                    Box::new({
                        let glob = glob.to_string();
                        move || glob_markdown::<BlogEntryContent>(&glob)
                    }),
                );

                content_sources.0.push(Box::new(content_source));

                combined_routes.push(&archetypes::blog::BlogIndex);
                combined_routes.push(&archetypes::blog::BlogEntry);
            }
            Archetype::MarkdownDoc => {
                todo!();
            }
        }
    }

    coronate(&combined_routes, content_sources, options)
}
